<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Live 3D Hand Control</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/examples/js/loaders/GLTFLoader.js"></script>

<style>
body {
  background:#111;
  color:#fff;
  font-family:Arial;
  margin:0;
  overflow:hidden;
}

#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 260px;
  padding: 10px;
  background: rgba(0,0,0,0.6);
  border-radius: 12px;
}

.slider {
  width: 100%;
}
</style>
</head>
<body>

<div id="ui">
  <h2>Hand Control</h2>

  Brryli<br>
  <input id="brr" type="range" min="0" max="1" step="0.01" class="slider">

  Biceps<br>
  <input id="bic" type="range" min="0" max="1" step="0.01" class="slider">

  Krahu<br>
  <input id="kra" type="range" min="-1" max="0" step="0.01" class="slider">

  Mbajtesi<br>
  <input id="mba" type="range" min="-1" max="0" step="0.01" class="slider">
</div>

<script>
let scene, camera, renderer, handModel;
let bones = {};

const URL = "https://pencil-faster-patents-keyword.trycloudflare.com/set";

// ---------------------
// THREE.JS SETUP
// ---------------------
scene = new THREE.Scene();
camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 1, 3);

renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// LIGHTS
const light = new THREE.DirectionalLight(0xffffff, 2);
light.position.set(3,3,3);
scene.add(light);

// LOAD GLB MODEL
const loader = new THREE.GLTFLoader();
loader.load(
    "hand.glb",
    function (gltf) {
        scene.add(gltf.scene);
        console.log("MODEL LOADED!");
    },
    undefined,
    function (error) {
        console.error("MODEL LOAD ERROR:", error);
    }
);



// ---------------------
// SLIDER → SEND COMMAND
// ---------------------
function sendValues() {
    let brr = parseFloat(document.getElementById("brr").value);
    let bic = parseFloat(document.getElementById("bic").value);
    let kra = parseFloat(document.getElementById("kra").value);
    let mba = parseFloat(document.getElementById("mba").value);

    fetch(`${URL}/set?brr=${brr}&bic=${bic}&kra=${kra}&mba=${mba}`)
    .catch(e => console.log("SEND ERROR", e));
}

setInterval(sendValues, 80);


// ---------------------
// FETCH JOINT STATE → UPDATE 3D MODEL
// ---------------------
function updateFromState() {
    fetch(`${URL}/state`)
      .then(r => r.json())
      .then(j => {
          if (!handModel) return;

          // Convert 0..1 into rotation for GLB bones
          if (bones["Brryli"]) bones["Brryli"].rotation.x = j.brryli * (Math.PI/2);
          if (bones["Biceps"])  bones["Biceps"].rotation.x = j.biceps * (Math.PI/2);
          if (bones["Krahu"])   bones["Krahu"].rotation.x = j.krahu * (Math.PI/2);
          if (bones["Mbajtesi"])bones["Mbajtesi"].rotation.x = j.mbajtesi * (Math.PI/2);
      })
      .catch(e => console.log("STATE ERROR", e));
}

setInterval(updateFromState, 50);


// ---------------------
// RENDER LOOP
// ---------------------
function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
}

animate();
</script>

</body>
</html>
